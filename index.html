<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B.Ed Notes Viewer</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  text-align:center;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
input{
  padding:10px;
  width:80%;
  margin-top:10px;
}
button{
  padding:10px 20px;
  margin-top:10px;
  background:#f59e0b;
  border:none;
  font-weight:bold;
}
canvas{
  width:100%;
  margin-bottom:20px;
}
.hidden{
  display:none;
}
.small{
  font-size:12px;
  opacity:.6;
}
</style>
</head>
<body>

<div class="container">

<h2>B.Ed Notes</h2>

<div id="activationSection">
  <p>Your Device ID:</p>
  <p id="deviceID" class="small"></p>

  <p>Enter Activation Code:</p>
  <input type="text" id="activationInput">
  <br>
  <button onclick="activate()">Activate</button>
  <p id="msg"></p>
</div>

<div id="viewer" class="hidden"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>

const SECRET_KEY = "MY_PRIVATE_SECRET_2025";

/* ðŸ”’ Paste encrypted base64 below */
const encryptedPDFBase64 = "PASTE_ENCRYPTED_BASE64_HERE";

/* DEVICE ID */
function getDeviceID(){
  return btoa(navigator.userAgent);
}

/* SHA256 */
async function sha256(message){
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ACTIVATE */
async function activate(){

  const input = document.getElementById("activationInput").value.trim();
  const deviceID = getDeviceID();

  const expected = await sha256(deviceID + SECRET_KEY);

  if(input === expected){
    localStorage.setItem("activated","true");
    loadBook();
  } else {
    document.getElementById("msg").innerText = "Invalid activation code.";
  }
}

/* LOAD BOOK */
async function loadBook(){

  document.getElementById("activationSection").style.display="none";
  document.getElementById("viewer").classList.remove("hidden");

  const encryptedBytes = Uint8Array.from(atob(encryptedPDFBase64), c => c.charCodeAt(0));

  const keyMaterial = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(SECRET_KEY)
  );

  const key = await crypto.subtle.importKey(
    "raw",
    keyMaterial,
    {name:"AES-GCM"},
    false,
    ["decrypt"]
  );

  const iv = encryptedBytes.slice(0,12);
  const data = encryptedBytes.slice(12);

  const decrypted = await crypto.subtle.decrypt(
    {name:"AES-GCM", iv},
    key,
    data
  );

  renderPDF(new Uint8Array(decrypted));
}

/* RENDER PDF AS IMAGES WITH WATERMARK */
async function renderPDF(data){

  pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  const pdf = await pdfjsLib.getDocument({data}).promise;
  const viewer = document.getElementById("viewer");

  for(let i=1;i<=pdf.numPages;i++){

    const page = await pdf.getPage(i);
    const viewport = page.getViewport({scale:1.5});

    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    const ctx = canvas.getContext("2d");

    await page.render({canvasContext:ctx,viewport}).promise;

    /* WATERMARK */
    ctx.font = "20px Arial";
    ctx.fillStyle = "rgba(255,0,0,0.25)";
    ctx.rotate(-0.5);
    ctx.fillText("Licensed Device: "+getDeviceID(),50,300);

    viewer.appendChild(canvas);
  }
}

/* INIT */
document.getElementById("deviceID").innerText = getDeviceID();

if(localStorage.getItem("activated")==="true"){
  loadBook();
}

</script>
</body>
</html>
