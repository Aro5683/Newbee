<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PDF Encrypt Tool</title>
</head>
<body>

<h2>Encrypt PDF</h2>

<input type="file" id="pdfFile" accept="application/pdf">
<button onclick="encryptPDF()">Encrypt</button>

<textarea id="output" style="width:100%;height:200px;margin-top:20px;"></textarea>

<script>

const SECRET_KEY = "MY_PRIVATE_SECRET_2025";

async function encryptPDF(){

  try{

    const file = document.getElementById("pdfFile").files[0];
    if(!file){
      alert("Upload PDF first");
      return;
    }

    const pdfBuffer = await file.arrayBuffer();

    const keyMaterial = await crypto.subtle.digest(
      "SHA-256",
      new TextEncoder().encode(SECRET_KEY)
    );

    const key = await crypto.subtle.importKey(
      "raw",
      keyMaterial,
      {name:"AES-GCM"},
      false,
      ["encrypt"]
    );

    const iv = crypto.getRandomValues(new Uint8Array(12));

    const encrypted = await crypto.subtle.encrypt(
      {name:"AES-GCM", iv},
      key,
      pdfBuffer
    );

    const combined = new Uint8Array(iv.length + encrypted.byteLength);
    combined.set(iv, 0);
    combined.set(new Uint8Array(encrypted), iv.length);

    // SAFE BASE64 CONVERSION (no spread operator crash)
    let binary = "";
    const chunkSize = 0x8000;

    for (let i = 0; i < combined.length; i += chunkSize) {
      const chunk = combined.subarray(i, i + chunkSize);
      binary += String.fromCharCode.apply(null, chunk);
    }

    const base64 = btoa(binary);

    document.getElementById("output").value = base64;

  }catch(e){
    console.error(e);
    alert("Encryption failed. Check console.");
  }

}

</script>

</body>
</html>
